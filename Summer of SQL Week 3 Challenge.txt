WITH TRANSACTION AS(
SELECT 
CASE 
        WHEN ONLINE_OR_IN_PERSON = 1 THEN 'Online'
        ELSE 'In-Person'
    END AS ONLINE_OR_IN_PERSON,
QUARTER(TO_TIMESTAMP(TRANSACTION_DATE, 'DD/MM/YYYY HH24:MI:SS')) AS QUARTER,
SUM(VALUE) AS VALUE
FROM PD2023_WK01
WHERE TRANSACTION_CODE LIKE '%DSB%'
GROUP BY QUARTER, ONLINE_OR_IN_PERSON)



SELECT TR.ONLINE_OR_IN_PERSON,TR.QUARTER, VALUE, TARGET_VALUE, (VALUE-TARGET_VALUE) AS VARIANCE_TO_TARGET
FROM TRANSACTION AS TR
LEFT JOIN 
(SELECT 
    ONLINE_OR_IN_PERSON, 
    REPLACE(QUARTER, 'Q', '') AS QUARTER, 
    TO_VARIANT(TARGET_VALUE) AS TARGET_VALUE
FROM(
SELECT *
FROM PD2023_WK03_TARGETS
   UNPIVOT (TARGET_VALUE
             FOR QUARTER IN (Q1,Q2,Q3,Q4)))) AS TA
ON TR.ONLINE_OR_IN_PERSON = TA.ONLINE_OR_IN_PERSON 
AND TR.QUARTER = TA.QUARTER
