
--1.How many customers has Foodie-Fi ever had?

SELECT COUNT(DISTINCT(CUSTOMER_ID)) AS NUMNER_OF_CUSTOMER
FROM SUBSCRIPTIONS

--2.What is the monthly distribution of trial plan start_date values for our dataset - use the start of the month as the group by value

SELECT MONTH(START_DATE) AS MONTH, COUNT(DISTINCT(CUSTOMER_ID)) AS NUMNER_OF_CUSTOMER
FROM SUBSCRIPTIONS
WHERE PLAN_ID = 0
GROUP BY MONTH
ORDER BY MONTH

--3.What plan start_date values occur after the year 2020 for our dataset? Show the breakdown by count of events for each plan_name

SELECT PLAN_NAME, COUNT(DISTINCT(CUSTOMER_ID)) AS NUMNER_OF_CUSTOMER
FROM SUBSCRIPTIONS S
LEFT JOIN PLANS P
ON S.PLAN_ID = P.PLAN_ID 
WHERE YEAR(START_DATE) >2020
GROUP BY PLAN_NAME

--4.What is the customer count and percentage of customers who have churned rounded to 1 decimal place?

SELECT
    COUNT(DISTINCT S.CUSTOMER_ID) AS NUMBER_OF_CUSTOMERS,
    COUNT(DISTINCT 
        CASE WHEN P.PLAN_NAME = 'churn' THEN S.CUSTOMER_ID END) AS NUMBER_OF_CHURN,
    ROUND((COUNT(DISTINCT 
        CASE WHEN P.PLAN_NAME = 'churn' THEN S.CUSTOMER_ID END) * 100.0 / COUNT(DISTINCT S.CUSTOMER_ID)),1) AS PERCENTAGE_OF_CHURN
FROM
    SUBSCRIPTIONS S
LEFT JOIN
    PLANS P ON S.PLAN_ID = P.PLAN_ID;


--5.How many customers have churned straight after their initial free trial - what percentage is this rounded to the nearest whole number?

WITH ROW_TABLE AS (
SELECT CUSTOMER_ID,S.PLAN_ID,START_DATE, PLAN_NAME,
ROW_NUMBER() OVER
(PARTITION BY CUSTOMER_ID
ORDER BY  CUSTOMER_ID ASC) AS ROW_NUM
FROM SUBSCRIPTIONS S
LEFT JOIN PLANS P
ON S.PLAN_ID = P.PLAN_ID 
ORDER BY TO_VARIANT(CUSTOMER_ID), S.PLAN_ID)

SELECT COUNT(DISTINCT CUSTOMER_ID) AS TOTAL_NUMBER_OF_CUSTOMERS,
(SELECT COUNT(DISTINCT(CUSTOMER_ID)) FROM ROW_TABLE WHERE ROW_NUM = 2 AND PLAN_NAME = 'churn') AS NUMBER_OF_CUSTMENR,
ROUND(((SELECT COUNT(DISTINCT(CUSTOMER_ID))FROM ROW_TABLE WHERE ROW_NUM = 2 AND PLAN_NAME = 'churn')* 100.0 / COUNT(DISTINCT CUSTOMER_ID)),0) AS PERCENTAGE_OF_CUSTOMER
FROM SUBSCRIPTIONS S



--6.What is the number and percentage of customer plans after their initial free trial?

WITH ROW_TABLE AS (
SELECT CUSTOMER_ID,S.PLAN_ID,START_DATE, PLAN_NAME,
ROW_NUMBER() OVER
(PARTITION BY CUSTOMER_ID
ORDER BY  CUSTOMER_ID ASC) AS ROW_NUM
FROM SUBSCRIPTIONS S
LEFT JOIN PLANS P
ON S.PLAN_ID = P.PLAN_ID 
ORDER BY TO_VARIANT(CUSTOMER_ID), S.PLAN_ID),

PLAN_COUNT AS (

SELECT PLAN_NAME,COUNT(DISTINCT(CUSTOMER_ID)) AS NUM_OF_CUSTOMER
FROM ROW_TABLE 
WHERE ROW_NUM = 2
GROUP BY PLAN_NAME),

TOTAL_CUSTOMER AS (

SELECT COUNT(DISTINCT(CUSTOMER_ID))AS TOTAL_NUM_OF_CUSTOMER
FROM SUBSCRIPTIONS)


SELECT 
    PLAN_NAME,
    NUM_OF_CUSTOMER,
    ROUND((NUM_OF_CUSTOMER * 100.0 / TOTAL_NUM_OF_CUSTOMER), 0) AS PERCENTAGE_OF_CUSTOMER
FROM PLAN_COUNT, TOTAL_CUSTOMER
ORDER BY PERCENTAGE_OF_CUSTOMER DESC

