WITH BANK_TABLE AS(
SELECT SPLIT_PART(TRANSACTION_CODE, '-', 1) AS BANK, 
MONTH(TO_TIMESTAMP(TRANSACTION_DATE, 'DD/MM/YYYY HH24:MI:SS')) AS MONTH, 
SUM(VALUE) AS VALUE
FROM PD2023_WK01
GROUP BY BANK, MONTH),

RANK_TABLE AS(
SELECT *,
RANK() 
    OVER (PARTITION BY MONTH ORDER BY VALUE DESC) as RANK_NUM,
FROM BANK_TABLE),

Avg_Rank_TABLE AS(
SELECT BANK, 
ROUND(AVG(RANK_NUM),1) AS AVG_RANK_PER_BANK
FROM RANK_TABLE
GROUP BY BANK),

Avg_Transaction_TABLE AS(
SELECT RANK_NUM, ROUND(AVG(VALUE),1) AS Avg_Transaction_Value_per_Rank
FROM RANK_TABLE
GROUP BY RANK_NUM)

SELECT * 
FROM RANK_TABLE RT
LEFT JOIN Avg_Rank_TABLE ART
ON RT.BANK = ART.BANK 
LEFT JOIN Avg_Transaction_TABLE ATT
ON RT.RANK_NUM = ATT.RANK_NUM
ORDER BY MONTH, RT.RANK_NUM
